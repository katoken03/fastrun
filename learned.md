# Fastrun プロジェクトの知見

## シェルヒストリーへのコマンド追加機能

### 問題と解決策

#### 問題
- fastrunで選択したコマンドがシェルのヒストリーに追加されない
- ユーザーは選択したコマンドを再度利用する際に、手動で入力する必要があった

#### 解決策
1. **`-t`オプション（--text-only）の追加**
   - コマンドの実行結果をテキスト形式で返すオプション
   - UI表示をスキップして、選択されたコマンドの文字列のみを出力

2. **シェル関数の実装**
   - `f` コマンドをラップするシェル関数を作成
   - `-t`オプションを使用してコマンド文字列を取得し、ヒストリーに追加
   - `eval`でコマンドを直接実行

3. **シェル関数生成コマンドの追加**
   - `generate-shell-function` コマンドを実装
   - ユーザーが簡単にシェル関数を設定できるよう、設定コマンドも表示

### 技術的な詳細

#### シェル関数の実装（Bash用）
```bash
# ========== Add this to your ~/.bash_profile ==========
f() {
    local cmd=$(command f -t "$@")
    if [ $? -eq 0 ] && [ -n "$cmd" ]; then
        history -s "$cmd"
        eval "$cmd"
    fi
}
```

### 学んだ教訓

1. **シンプルな実装の重要性**
   - 当初、出力解析とマーカー方式を使用していたが、`-t`オプションによる直接的なアプローチの方がシンプルで信頼性が高い

2. **シェル関数の再帰呼び出し防止**
   - シェル関数と同名のコマンドを呼び出す際は、`command` プレフィックスを使用して再帰呼び出しを防止する必要がある

3. **シェル関数の追加方法**
   - ヒアドキュメント（`cat << 'EOF'`）を使用することで、シングルクォートやバックスラッシュなどの特殊文字を含むシェル関数を安全に追記できる

4. **ユーザビリティの向上**
   - コマンド生成機能により、ユーザーは設定手順をコピー＆ペーストするだけで済むようになった
   - 目立つコメントを追加することで、シェル設定ファイル内でのシェル関数の識別が容易になった

### 使用方法

1. シェル関数を生成する：
   ```
   f generate-shell-function --shell=bash
   ```

2. 表示されたコマンドをコピー＆ペーストして、シェル関数を `.bash_profile` に追加する

3. シェル設定を再読み込みする：
   ```
   source ~/.bash_profile
   ```

4. `f` コマンドを使用すると、選択したコマンドがヒストリーに追加される
